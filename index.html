<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å®æ—¶äº¤äº’ç‰Œå±€è®¡åˆ†å™¨</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #fff;
            padding: 10px;
            min-height: 100vh;
        }
        
        .app-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        /* å¤´éƒ¨åŒºåŸŸ */
        .app-header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(52, 152, 219, 0.3);
        }
        
        .app-title {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 5px;
            background: linear-gradient(90deg, #3498db, #2ecc71, #9b59b6);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        
        .app-subtitle {
            color: #bdc3c7;
            font-size: 0.9rem;
        }
        
        /* æˆ¿é—´æ§åˆ¶åŒºåŸŸ */
        .room-controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
        }
        
        .room-info {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .room-id {
            font-weight: 600;
            color: #ecf0f1;
            font-size: 1.1rem;
        }
        
        .room-id span {
            background: rgba(52, 152, 219, 0.2);
            padding: 5px 10px;
            border-radius: 5px;
            font-family: monospace;
        }
        
        .room-actions {
            display: flex;
            gap: 10px;
        }
        
        .room-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .copy-btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }
        
        .share-btn {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            color: white;
        }
        
        .leave-btn {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }
        
        .player-count {
            display: flex;
            align-items: center;
            gap: 5px;
            color: #bdc3c7;
        }
        
        /* ç©å®¶è¿æ¥çŠ¶æ€ */
        .players-online {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        
        .player-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            border-left: 3px solid #2ecc71;
        }
        
        .player-status.offline {
            border-left-color: #e74c3c;
        }
        
        .player-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            background: linear-gradient(135deg, #3498db, #2ecc71);
            color: white;
        }
        
        .player-name {
            font-weight: 600;
            color: #ecf0f1;
        }
        
        /* å…¨å±€æ§åˆ¶æŒ‰é’® */
        .global-controls {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        
        @media (min-width: 768px) {
            .global-controls {
                grid-template-columns: repeat(5, 1fr);
            }
        }
        
        .global-btn {
            padding: 12px 8px;
            border: none;
            border-radius: 10px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 70px;
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: #ecf0f1;
        }
        
        .global-btn i {
            font-size: 1.2rem;
            margin-bottom: 5px;
        }
        
        #addPlayerBtn {
            background: linear-gradient(135deg, #3498db, #2980b9);
        }
        
        #settlementBtn {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
        }
        
        #endGameBtn {
            background: linear-gradient(135deg, #f39c12, #d35400);
        }
        
        #newRoundBtn {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
        }
        
        #resetAllBtn {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }
        
        /* ç©å®¶å¡ç‰‡å®¹å™¨ */
        .players-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        @media (min-width: 768px) {
            .players-container {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        /* åˆå§‹çŠ¶æ€æç¤º */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #95a5a6;
            font-size: 1.1rem;
            background-color: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            border: 2px dashed #34495e;
            grid-column: 1 / -1;
        }
        
        /* ç©å®¶å¡ç‰‡æ ·å¼ */
        .player-card {
            background: linear-gradient(145deg, rgba(44, 62, 80, 0.9), rgba(52, 73, 94, 0.9));
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            position: relative;
            overflow: hidden;
            border-left: 6px solid #3498db;
        }
        
        .player-card:nth-child(even) {
            border-left-color: #2ecc71;
        }
        
        .player-card:nth-child(3n) {
            border-left-color: #9b59b6;
        }
        
        /* ç©å®¶å¤´éƒ¨ */
        .player-header {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            background: linear-gradient(135deg, #3498db, #2ecc71);
            color: white;
            margin-right: 12px;
            flex-shrink: 0;
        }
        
        .player-name {
            font-size: 1.2rem;
            font-weight: 700;
            color: #ecf0f1;
            padding: 8px 10px;
            border: 1px solid #34495e;
            border-radius: 8px;
            background-color: rgba(0, 0, 0, 0.2);
            flex: 1;
            min-height: 44px;
            display: flex;
            align-items: center;
        }
        
        /* æ€»åˆ†æ˜¾ç¤º */
        .total-score-container {
            text-align: center;
            margin: 15px 0;
            padding: 15px;
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.2), rgba(52, 152, 219, 0.1));
            border-radius: 10px;
            position: relative;
            overflow: hidden;
        }
        
        .total-score-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #3498db, #2ecc71, #9b59b6);
        }
        
        .total-score-label {
            font-size: 0.9rem;
            color: #bdc3c7;
            margin-bottom: 5px;
        }
        
        .total-score {
            font-size: 2.5rem;
            font-weight: 900;
            color: #fff;
            transition: all 0.3s ease;
            text-shadow: 0 0 10px rgba(52, 152, 219, 0.5);
        }
        
        .score-updated {
            color: #2ecc71;
            transform: scale(1.05);
        }
        
        /* ç»™åˆ†æ“ä½œåŒºåŸŸ */
        .transfer-controls {
            margin-bottom: 15px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
        }
        
        .transfer-title {
            font-size: 1rem;
            font-weight: 700;
            color: #ecf0f1;
            margin-bottom: 10px;
            text-align: center;
        }
        
        .transfer-row {
            margin-bottom: 10px;
        }
        
        .transfer-label {
            font-weight: 600;
            color: #bdc3c7;
            margin-bottom: 5px;
            display: block;
        }
        
        .player-select, .transfer-amount {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #34495e;
            border-radius: 8px;
            font-size: 1rem;
            background-color: rgba(0, 0, 0, 0.3);
            color: #ecf0f1;
            -webkit-appearance: none;
            appearance: none;
        }
        
        .transfer-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }
        
        .transfer-btn {
            padding: 12px 10px;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .transfer-send {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: white;
        }
        
        .transfer-request {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }
        
        /* å¿«æ·æŒ‰é’®åŒº */
        .quick-score-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-top: 10px;
        }
        
        .quick-btn {
            padding: 10px 5px;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            min-height: 44px;
        }
        
        .positive-quick {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: white;
        }
        
        .negative-quick {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }
        
        /* å¾—åˆ†å†å² */
        .score-history {
            margin-top: 15px;
        }
        
        .history-title {
            font-size: 1rem;
            font-weight: 700;
            color: #ecf0f1;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #34495e;
        }
        
        .history-list {
            list-style-type: none;
            max-height: 150px;
            overflow-y: auto;
        }
        
        .history-list::-webkit-scrollbar {
            width: 4px;
        }
        
        .history-list::-webkit-scrollbar-thumb {
            background-color: #3498db;
            border-radius: 2px;
        }
        
        .history-item {
            padding: 10px 12px;
            margin-bottom: 8px;
            background-color: rgba(0, 0, 0, 0.2);
            border-radius: 6px;
            border-left: 4px solid #3498db;
            font-size: 0.85rem;
            color: #ecf0f1;
        }
        
        .positive-score {
            border-left-color: #2ecc71;
        }
        
        .negative-score {
            border-left-color: #e74c3c;
        }
        
        .transfer-history {
            border-left-color: #9b59b6;
        }
        
        /* ç§»é™¤æŒ‰é’® */
        .remove-player {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            border: none;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }
        
        /* å¯¹è¯æ¡†æ ·å¼ */
        .dialog-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 15px;
            box-sizing: border-box;
        }
        
        .dialog-content {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            padding: 25px;
            border-radius: 15px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }
        
        .dialog-title {
            font-size: 1.5rem;
            color: #9b59b6;
            margin-bottom: 15px;
        }
        
        .dialog-message {
            font-size: 1.1rem;
            color: #ecf0f1;
            margin-bottom: 20px;
            line-height: 1.5;
        }
        
        .dialog-amount {
            font-size: 2rem;
            font-weight: 900;
            color: #e74c3c;
            margin: 15px 0;
            text-shadow: 0 0 10px rgba(231, 76, 60, 0.5);
        }
        
        .dialog-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 20px;
        }
        
        .dialog-btn {
            padding: 12px 15px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .dialog-accept {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: white;
        }
        
        .dialog-reject {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }
        
        .dialog-close {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            width: 100%;
        }
        
        /* èƒœåˆ©ç»“ç®—ç”»é¢ */
        .victory-content {
            background: linear-gradient(135deg, #2c3e50, #1a1a2e);
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            position: relative;
            overflow: hidden;
            border: 5px solid #ffd700;
        }
        
        .victory-title {
            font-size: 1.8rem;
            color: #ffd700;
            margin-bottom: 15px;
            text-shadow: 2px 2px 0 rgba(0,0,0,0.3);
        }
        
        .winner-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 20px 0;
            padding: 20px;
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(255, 165, 0, 0.1));
            border-radius: 12px;
            border: 3px solid #ffd700;
            position: relative;
        }
        
        .crown {
            font-size: 2.5rem;
            position: absolute;
            top: -20px;
            color: #ffd700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        
        .winner-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            background: linear-gradient(135deg, #3498db, #2ecc71);
            color: white;
            margin-bottom: 15px;
            border: 4px solid #ffd700;
        }
        
        .winner-name {
            font-size: 1.8rem;
            color: #ffd700;
            font-weight: 800;
            margin-bottom: 10px;
        }
        
        .winner-score {
            font-size: 1.8rem;
            color: #2ecc71;
            font-weight: 800;
            background-color: rgba(0, 0, 0, 0.3);
            padding: 8px 20px;
            border-radius: 50px;
        }
        
        .victory-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 25px;
        }
        
        .victory-btn {
            padding: 12px 15px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        /* åŠ å…¥æˆ¿é—´å¯¹è¯æ¡† */
        .join-room-dialog {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            padding: 30px;
            border-radius: 15px;
            width: 100%;
            max-width: 400px;
            text-align: center;
        }
        
        .join-title {
            font-size: 1.8rem;
            color: #3498db;
            margin-bottom: 20px;
        }
        
        .join-input {
            width: 100%;
            padding: 15px;
            margin-bottom: 20px;
            border: 2px solid #34495e;
            border-radius: 8px;
            font-size: 1.1rem;
            background-color: rgba(0, 0, 0, 0.3);
            color: #ecf0f1;
            text-align: center;
        }
        
        .join-input:focus {
            outline: none;
            border-color: #3498db;
        }
        
        .join-buttons {
            display: flex;
            gap: 10px;
        }
        
        .join-btn {
            flex: 1;
            padding: 12px 15px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .join-create {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: white;
        }
        
        .join-join {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }
        
        /* è¿æ¥çŠ¶æ€ */
        .connection-status {
            position: fixed;
            bottom: 10px;
            right: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: rgba(0, 0, 0, 0.6);
            border-radius: 8px;
            font-size: 0.9rem;
            z-index: 100;
        }
        
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }
        
        .status-connected {
            background-color: #2ecc71;
            box-shadow: 0 0 10px #2ecc71;
        }
        
        .status-disconnected {
            background-color: #e74c3c;
            box-shadow: 0 0 10px #e74c3c;
        }
        
        /* æ•°æ®çŠ¶æ€æç¤º */
        .data-status {
            text-align: center;
            margin-top: 15px;
            color: #bdc3c7;
            font-size: 0.8rem;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
        }
        
        /* åº•éƒ¨ä¿¡æ¯ */
        .app-footer {
            text-align: center;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid rgba(52, 152, 219, 0.3);
            color: #bdc3c7;
            font-size: 0.8rem;
        }
        
        /* æ¶ˆæ¯æç¤º */
        .message-toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 20px;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 1000;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            display: none;
        }
        
        .message-toast.show {
            display: block;
            animation: slideDown 0.3s ease;
        }
        
        @keyframes slideDown {
            from { top: -50px; opacity: 0; }
            to { top: 20px; opacity: 1; }
        }
        
        /* è¯­éŸ³æ§åˆ¶ */
        .voice-control {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
        }
        
        .voice-label {
            font-weight: 600;
            color: #ecf0f1;
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 26px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #e74c3c;
            transition: .4s;
            border-radius: 34px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: #2ecc71;
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }
        
        .voice-status {
            font-size: 0.9rem;
            font-weight: 600;
            min-width: 40px;
        }
        
        .voice-on {
            color: #2ecc71;
        }
        
        .voice-off {
            color: #e74c3c;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- è¿æ¥çŠ¶æ€æŒ‡ç¤ºå™¨ -->
        <div class="connection-status" id="connectionStatus">
            <div class="status-indicator status-disconnected" id="statusIndicator"></div>
            <span id="statusText">è¿æ¥ä¸­...</span>
        </div>
        
        <!-- æ¶ˆæ¯æç¤º -->
        <div class="message-toast" id="messageToast"></div>
        
        <!-- åŠ å…¥æˆ¿é—´å¯¹è¯æ¡† -->
        <div class="dialog-overlay" id="joinRoomDialog" style="display: flex;">
            <div class="join-room-dialog">
                <h2 class="join-title">åŠ å…¥ç‰Œå±€æˆ¿é—´</h2>
                <input type="text" class="join-input" id="roomIdInput" placeholder="è¾“å…¥æˆ¿é—´å· (æˆ–ç•™ç©ºåˆ›å»ºæ–°æˆ¿é—´)">
                <input type="text" class="join-input" id="playerNameInput" placeholder="è¯·è¾“å…¥æ‚¨çš„æ˜µç§°" value="ç©å®¶">
                <div class="join-buttons">
                    <button class="join-btn join-create" id="createRoomBtn">åˆ›å»ºæˆ¿é—´</button>
                    <button class="join-btn join-join" id="joinRoomBtn">åŠ å…¥æˆ¿é—´</button>
                </div>
            </div>
        </div>
        
        <!-- ä¸»åº”ç”¨ç•Œé¢ (é»˜è®¤éšè—) -->
        <div id="mainApp" style="display: none;">
            <header class="app-header">
                <h1 class="app-title">å®æ—¶äº¤äº’ç‰Œå±€è®¡åˆ†å™¨</h1>
                <div class="app-subtitle">å¤šäººå®æ—¶äº¤äº’ | è‡ªåŠ¨è¯­éŸ³ | ç§»åŠ¨ç«¯ä¼˜åŒ–</div>
                
                <!-- è¯­éŸ³æ§åˆ¶ -->
                <div class="voice-control">
                    <div class="voice-label">è¯­éŸ³:</div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="voiceToggle" checked>
                        <span class="toggle-slider"></span>
                    </label>
                    <div class="voice-status voice-on" id="voiceStatus">å¼€å¯</div>
                </div>
            </header>
            
            <!-- æˆ¿é—´æ§åˆ¶åŒºåŸŸ -->
            <div class="room-controls">
                <div class="room-info">
                    <div class="room-id">æˆ¿é—´å·: <span id="currentRoomId">---</span></div>
                    <div class="player-count">
                        <i class="fas fa-users"></i>
                        <span id="onlineCount">1</span>äººåœ¨çº¿
                    </div>
                    <div class="room-actions">
                        <button class="room-btn copy-btn" id="copyRoomBtn">
                            <i class="fas fa-copy"></i>å¤åˆ¶æˆ¿é—´å·
                        </button>
                        <button class="room-btn share-btn" id="shareRoomBtn">
                            <i class="fas fa-share-alt"></i>åˆ†äº«æˆ¿é—´
                        </button>
                        <button class="room-btn leave-btn" id="leaveRoomBtn">
                            <i class="fas fa-sign-out-alt"></i>ç¦»å¼€æˆ¿é—´
                        </button>
                    </div>
                </div>
                
                <div class="players-online" id="playersOnline">
                    <!-- åœ¨çº¿ç©å®¶çŠ¶æ€åŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
            
            <!-- å…¨å±€æ§åˆ¶æŒ‰é’® -->
            <div class="global-controls">
                <button class="global-btn" id="addPlayerBtn">
                    <div><i class="fas fa-user-plus"></i></div>
                    <div>æ·»åŠ ç©å®¶</div>
                </button>
                <button class="global-btn" id="settlementBtn">
                    <div><i class="fas fa-trophy"></i></div>
                    <div>ç»“ç®—æ’å</div>
                </button>
                <button class="global-btn" id="endGameBtn">
                    <div><i class="fas fa-flag-checkered"></i></div>
                    <div>ç»“æŸå¯¹å±€</div>
                </button>
                <button class="global-btn" id="newRoundBtn">
                    <div><i class="fas fa-redo"></i></div>
                    <div>æ–°ä¸€å±€</div>
                </button>
                <button class="global-btn" id="resetAllBtn">
                    <div><i class="fas fa-trash"></i></div>
                    <div>å®Œå…¨é‡ç½®</div>
                </button>
            </div>
            
            <!-- ç©å®¶å¡ç‰‡å®¹å™¨ -->
            <div class="players-container" id="playersContainer">
                <div class="empty-state" id="emptyState">
                    æš‚æ— ç©å®¶ï¼Œè¯·ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æ·»åŠ 
                </div>
            </div>
            
            <!-- æ•°æ®çŠ¶æ€æç¤º -->
            <div class="data-status" id="dataStatus">
                æ•°æ®å®æ—¶åŒæ­¥ä¸­ï¼Œæ‰€æœ‰ç©å®¶å…±äº«åŒä¸€ç‰Œå±€
            </div>
            
            <!-- ç»“ç®—æ’åå¯¹è¯æ¡† -->
            <div class="dialog-overlay" id="settlementDialog" style="display: none;">
                <div class="dialog-content">
                    <h2 class="dialog-title">æœ€ç»ˆæ’åç»“ç®—</h2>
                    <div id="rankingsList">
                        <!-- æ’ååŠ¨æ€ç”Ÿæˆ -->
                    </div>
                    <button class="dialog-btn dialog-close" id="closeSettlementBtn">å…³é—­</button>
                </div>
            </div>
            
            <!-- åˆ†æ•°è¯·æ±‚å¯¹è¯æ¡† -->
            <div class="dialog-overlay" id="requestDialog" style="display: none;">
                <div class="dialog-content">
                    <h2 class="dialog-title">åˆ†æ•°è¯·æ±‚</h2>
                    <div class="dialog-message" id="requestMessage">
                        <!-- è¯·æ±‚ä¿¡æ¯åŠ¨æ€ç”Ÿæˆ -->
                    </div>
                    <div class="dialog-amount" id="requestAmount">
                        <!-- è¯·æ±‚é‡‘é¢åŠ¨æ€ç”Ÿæˆ -->
                    </div>
                    <div class="dialog-buttons">
                        <button class="dialog-btn dialog-accept" id="requestAcceptBtn">æ¥å—è¯·æ±‚</button>
                        <button class="dialog-btn dialog-reject" id="requestRejectBtn">æ‹’ç»è¯·æ±‚</button>
                    </div>
                </div>
            </div>
            
            <!-- èƒœåˆ©ç»“ç®—ç”»é¢ -->
            <div class="dialog-overlay" id="victoryOverlay" style="display: none;">
                <div class="victory-content">
                    <h2 class="victory-title">ğŸ† å¯¹å±€ç»“æŸ ğŸ†</h2>
                    <div class="winner-container" id="winnerContainer">
                        <!-- è·èƒœè€…ä¿¡æ¯åŠ¨æ€ç”Ÿæˆ -->
                    </div>
                    <div class="victory-buttons">
                        <button class="victory-btn dialog-close" id="victoryCloseBtn">è¿”å›æ¸¸æˆ</button>
                        <button class="victory-btn dialog-accept" id="victoryNewGameBtn">æ–°æ¸¸æˆ</button>
                    </div>
                </div>
            </div>
            
            <footer class="app-footer">
                <p>å®æ—¶äº¤äº’ç‰Œå±€è®¡è®¡åˆ†å™¨ Â© 2023 | å¤šäººå®æ—¶äº¤äº’ | æˆ¿é—´ç³»ç»Ÿ</p>
            </footer>
        </div>
    </div>

    <!-- Socket.io å®¢æˆ·ç«¯åº“ -->
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    
    <script>
        // å…¨å±€å˜é‡
     
        let players = [];
        let currentRequest = null;
        let voiceEnabled = true;
        let currentPlayerId = null;
        let currentRoomId = null;
        let currentPlayerName = "ç©å®¶";
        let onlinePlayers = {};
        
        // é»˜è®¤å¤´åƒåˆ—è¡¨
        const defaultAvatars = [
            'ğŸ˜€', 'ğŸ˜', 'ğŸ¤©', 'ğŸ˜Š', 'ğŸ˜', 'ğŸ¥³', 'ğŸ¤ ', 'ğŸ§',
            'ğŸ‘¨', 'ğŸ‘©', 'ğŸ‘¦', 'ğŸ‘§', 'ğŸ‘¨â€ğŸ’»', 'ğŸ‘©â€ğŸ’»', 'ğŸ¦¸', 'ğŸ¦¹'
        ];
        
        // å¿«æ·åˆ†å€¼æŒ‰é’®
        const quickScores = [
            { label: '+10', value: 10, type: 'positive' },
            { label: '+5', value: 5, type: 'positive' },
            { label: '+1', value: 1, type: 'positive' },
            { label: '-1', value: -1, type: 'negative' },
            { label: '-5', value: -5, type: 'negative' },
            { label: '-10', value: -10, type: 'negative' }
        ];
        
        // æŠ¼éŸµè¯­éŸ³æ–‡æœ¬
        const rhymeVoices = {
            victory: [
                "ç‰Œå±€å·²ç»“æŸï¼Œå† å†›å·²å‡ºç‚‰ï¼Œåˆ†æ•°æœ€é«˜è€…ï¼ŒçœŸæ˜¯æœ‰é£åº¦ï¼",
                "æ¸¸æˆå·²å®Œç»“ï¼Œæ’åå·²æ­æ™“ï¼Œèƒœåˆ©è€…ç¬‘å®¹ï¼Œå¦‚é˜³å…‰æ™®ç…§ï¼",
                "å¯¹å±€ç»ˆè½å¹•ï¼Œèƒœè´Ÿå·²åˆ†æ™“ï¼Œå† å†›å±•ç¬‘é¢œï¼Œè£è€€æ‰‹ä¸­æŠ±ï¼"
            ],
            transfer: [
                "åˆ†æ•°è½¬å‡ºå»ï¼Œå‹è°Šä¸è½¬ç§»ï¼Œç‰Œå±€ç»§ç»­ç©ï¼Œæ¬¢ä¹ä¸åœæ¯ï¼",
                "è½¬è´¦å·²å®Œæˆï¼Œåˆ†æ•°å·²å˜æ›´ï¼Œå‹æƒ…æ›´æ·±åšï¼Œå¿«ä¹å†æ”€å‡ï¼"
            ],
            request: [
                "è¯·æ±‚å·²å‘å‡ºï¼Œç­‰å¾…å›å¤ä¸­ï¼Œå‹æƒ…ä»·æ›´é«˜ï¼Œåˆ†æ•°å¯æµé€šï¼"
            ],
            accept: [
                "è¯·æ±‚å·²æ¥å—ï¼Œåˆ†æ•°å·²è½¬èµ°ï¼Œå‹è°Šæ›´æ·±åšï¼Œå¿«ä¹å¿ƒä¸­ç•™ï¼"
            ],
            reject: [
                "è¯·æ±‚è¢«å©‰æ‹’ï¼Œåˆ†æ•°æ²¡è½¬å»ï¼Œå‹è°Šä»å¸¸åœ¨ï¼Œä¸‹æ¬¡å†ç»§ç»­ï¼"
            ],
            newPlayer: [
                "æ–°ç©å®¶åŠ å…¥ï¼Œç‰Œå±€æ›´ä¸°å¯Œï¼Œå¤§å®¶ä¸€èµ·ç©ï¼Œæ¬¢ä¹æŒ¡ä¸ä½ï¼"
            ],
            playerLeft: [
                "æœ‰ç©å®¶ç¦»å¼€ï¼Œç‰Œå±€ç»§ç»­å¼€ï¼Œå‰©ä¸‹å°ä¼™ä¼´ï¼Œç»§ç»­å±•é£é‡‡ï¼"
            ]
        };
        
        // DOM å…ƒç´ 
        const joinRoomDialog = document.getElementById('joinRoomDialog');
        const mainApp = document.getElementById('mainApp');
        const roomIdInput = document.getElementById('roomIdInput');
        const playerNameInput = document.getElementById('playerNameInput');
        const createRoomBtn = document.getElementById('createRoomBtn');
        const joinRoomBtn = document.getElementById('joinRoomBtn');
        const currentRoomIdElement = document.getElementById('currentRoomId');
        const onlineCountElement = document.getElementById('onlineCount');
        const playersOnlineElement = document.getElementById('playersOnline');
        const copyRoomBtn = document.getElementById('copyRoomBtn');
        const shareRoomBtn = document.getElementById('shareRoomBtn');
        const leaveRoomBtn = document.getElementById('leaveRoomBtn');
        const connectionStatus = document.getElementById('connectionStatus');
        const statusIndicator = document.getElementById('statusIndicator');
        const statusText = document.getElementById('statusText');
        const messageToast = document.getElementById('messageToast');
        
        // æ¸¸æˆç›¸å…³DOMå…ƒç´ 
        const playersContainer = document.getElementById('playersContainer');
        const emptyState = document.getElementById('emptyState');
        const addPlayerBtn = document.getElementById('addPlayerBtn');
        const newRoundBtn = document.getElementById('newRoundBtn');
        const resetAllBtn = document.getElementById('resetAllBtn');
        const settlementBtn = document.getElementById('settlementBtn');
        const endGameBtn = document.getElementById('endGameBtn');
        const victoryOverlay = document.getElementById('victoryOverlay');
        const winnerContainer = document.getElementById('winnerContainer');
        const victoryCloseBtn = document.getElementById('victoryCloseBtn');
        const victoryNewGameBtn = document.getElementById('victoryNewGameBtn');
        const requestDialog = document.getElementById('requestDialog');
        const requestMessage = document.getElementById('requestMessage');
        const requestAmount = document.getElementById('requestAmount');
        const requestAcceptBtn = document.getElementById('requestAcceptBtn');
        const requestRejectBtn = document.getElementById('requestRejectBtn');
        const settlementDialog = document.getElementById('settlementDialog');
        const rankingsList = document.getElementById('rankingsList');
        const closeSettlementBtn = document.getElementById('closeSettlementBtn');
        const dataStatus = document.getElementById('dataStatus');
        const voiceToggle = document.getElementById('voiceToggle');
        const voiceStatus = document.getElementById('voiceStatus');
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            // è®¾ç½®é»˜è®¤ç©å®¶åç§°
            playerNameInput.value = `ç©å®¶${Math.floor(Math.random() * 1000)}`;
            
            // åŠ å…¥æˆ¿é—´æŒ‰é’®äº‹ä»¶
            createRoomBtn.addEventListener('click', createRoom);
            joinRoomBtn.addEventListener('click', joinRoom);
            
            // æˆ¿é—´æ“ä½œæŒ‰é’®äº‹ä»¶
            copyRoomBtn.addEventListener('click', copyRoomId);
            shareRoomBtn.addEventListener('click', shareRoom);
            leaveRoomBtn.addEventListener('click', leaveRoom);
            
            // æ¸¸æˆæ§åˆ¶æŒ‰é’®äº‹ä»¶
            addPlayerBtn.addEventListener('click', addPlayer);
            newRoundBtn.addEventListener('click', newRound);
            resetAllBtn.addEventListener('click', resetAll);
            settlementBtn.addEventListener('click', showSettlement);
            endGameBtn.addEventListener('click', endGame);
            
            // èƒœåˆ©ç»“ç®—æŒ‰é’®äº‹ä»¶
            victoryCloseBtn.addEventListener('click', () => {
                victoryOverlay.style.display = 'none';
            });
            
            victoryNewGameBtn.addEventListener('click', () => {
                victoryOverlay.style.display = 'none';
                newRound();
            });
            
            // è¯·æ±‚å¯¹è¯æ¡†æŒ‰é’®äº‹ä»¶
            requestAcceptBtn.addEventListener('click', acceptRequest);
            requestRejectBtn.addEventListener('click', rejectRequest);
            
            // ç»“ç®—å¯¹è¯æ¡†å…³é—­æŒ‰é’®
            closeSettlementBtn.addEventListener('click', () => {
                settlementDialog.style.display = 'none';
            });
            
            // è¯­éŸ³æ§åˆ¶
            voiceToggle.addEventListener('change', toggleVoice);
            
            // ç‚¹å‡»å¯¹è¯æ¡†å¤–éƒ¨å…³é—­
            document.addEventListener('click', (e) => {
                if (e.target === settlementDialog) {
                    settlementDialog.style.display = 'none';
                }
                if (e.target === requestDialog) {
                    requestDialog.style.display = 'none';
                }
                if (e.target === victoryOverlay) {
                    victoryOverlay.style.display = 'none';
                }
            });
            
            // åˆå§‹åŒ–è¯­éŸ³
            initVoice();
            
            // åˆå§‹åŒ–Socketè¿æ¥
            initSocket();
            
            // è¾“å…¥æ¡†å›è½¦é”®æ”¯æŒ
            roomIdInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') joinRoom();
            });
            
            playerNameInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') joinRoom();
            });
        });
      // 1. å£°æ˜å…¨å±€å˜é‡ï¼ˆå…¨æ–‡ä»¶åªå‡†æœ‰è¿™ä¸€å¤„ let socketï¼‰
let socket; 

function initSocket() {
    // 2. æŒ‡å‘ä½ çš„ Zeabur åç«¯åœ°å€
    const serverUrl = 'https://wjz.zeabur.app';
    
    // 3. åˆå§‹åŒ–è¿æ¥ï¼Œå¼ºåˆ¶å…ˆä½¿ç”¨è½®è¯¢ä»¥é¿å¼€ Zeabur çš„ WebSocket 502 é™åˆ¶
    socket = io(serverUrl, {
        transports: ['polling', 'websocket'],
        reconnection: true,
        reconnectionAttempts: 5
    });

    // 4. ã€å…³é”®ã€‘æŠŠæ‰€æœ‰ .on çš„ç›‘å¬å™¨å…¨éƒ½æ¬è¿›è¿™ä¸ªå‡½æ•°é‡Œï¼
    // è¿™æ ·èƒ½å½»åº•è§£å†³æˆªå›¾ä¸­çš„ "Cannot read properties of undefined (reading 'on')" æŠ¥é”™
    socket.on('connect', () => {
        console.log('Successfully connected to server');
        // åªæœ‰è¿æ¥æˆåŠŸåï¼Œæ‰å…è®¸æ‰§è¡Œç›¸å…³é€»è¾‘
        if (typeof updateConnectionStatus === 'function') {
            updateConnectionStatus(true);
        }
    });

    // å¦‚æœä½ ä»£ç åé¢è¿˜æœ‰ socket.on('roomCreated'...) ç­‰ï¼Œä¹Ÿè¦æŒªåˆ°è¿™é‡Œé¢æ¥
    socket.on('error', (err) => {
        console.error('Socket connection error:', err);
    });
}

// 5. ç¡®ä¿åœ¨é¡µé¢åŠ è½½å®Œæˆåè°ƒç”¨åˆå§‹åŒ–
window.onload = () => {
    initSocket();
};
            // æˆ¿é—´äº‹ä»¶
            socket.on('room_created', (data) => {
                console.log('æˆ¿é—´åˆ›å»ºæˆåŠŸ:', data);
                joinRoomDialog.style.display = 'none';
                mainApp.style.display = 'block';
                currentRoomId = data.roomId;
                currentPlayerId = data.playerId;
                currentPlayerName = data.playerName;
                currentRoomIdElement.textContent = currentRoomId;
                showMessage(`æˆ¿é—´ ${currentRoomId} åˆ›å»ºæˆåŠŸ`);
                updateOnlinePlayers(data.players);
            });
            
            socket.on('room_joined', (data) => {
                console.log('åŠ å…¥æˆ¿é—´æˆåŠŸ:', data);
                joinRoomDialog.style.display = 'none';
                mainApp.style.display = 'block';
                currentRoomId = data.roomId;
                currentPlayerId = data.playerId;
                currentPlayerName = data.playerName;
                currentRoomIdElement.textContent = currentRoomId;
                players = data.players || [];
                updateOnlinePlayers(data.onlinePlayers);
                renderPlayers();
                showMessage(`æˆåŠŸåŠ å…¥æˆ¿é—´ ${currentRoomId}`);
            });
            
            socket.on('room_error', (data) => {
                console.error('æˆ¿é—´é”™è¯¯:', data);
                showMessage(data.message || 'æˆ¿é—´æ“ä½œå¤±è´¥');
            });
            
            socket.on('player_joined', (data) => {
                console.log('æ–°ç©å®¶åŠ å…¥:', data);
                updateOnlinePlayers(data.onlinePlayers);
                showMessage(`${data.playerName} åŠ å…¥äº†æˆ¿é—´`);
                speakText(rhymeVoices.newPlayer[0]);
            });
            
            socket.on('player_left', (data) => {
                console.log('ç©å®¶ç¦»å¼€:', data);
                updateOnlinePlayers(data.onlinePlayers);
                if (data.playerName) {
                    showMessage(`${data.playerName} ç¦»å¼€äº†æˆ¿é—´`);
                    speakText(rhymeVoices.playerLeft[0]);
                }
            });
            
            socket.on('players_update', (data) => {
                console.log('ç©å®¶æ•°æ®æ›´æ–°:', data);
                players = data.players || [];
                renderPlayers();
            });
            
            socket.on('score_updated', (data) => {
                console.log('åˆ†æ•°æ›´æ–°:', data);
                // æ›´æ–°æœ¬åœ°ç©å®¶æ•°æ®
                const playerIndex = players.findIndex(p => p.id === data.playerId);
                if (playerIndex !== -1) {
                    players[playerIndex] = data.player;
                    renderPlayers();
                    
                    // æ˜¾ç¤ºåˆ†æ•°æ›´æ–°åŠ¨ç”»
                    const scoreElement = document.querySelector(`.player-card[data-id="${data.playerId}"] .total-score`);
                    if (scoreElement) {
                        scoreElement.classList.add('score-updated');
                        setTimeout(() => {
                            scoreElement.classList.remove('score-updated');
                        }, 500);
                    }
                }
            });
            
            socket.on('game_reset', (data) => {
                console.log('æ¸¸æˆé‡ç½®:', data);
                players = data.players || [];
                renderPlayers();
                showMessage('æ¸¸æˆå·²é‡ç½®');
            });
            
            socket.on('new_round', (data) => {
                console.log('æ–°ä¸€å±€å¼€å§‹:', data);
                players = data.players || [];
                renderPlayers();
                showMessage('æ–°ä¸€å±€å¼€å§‹');
            });
            
            socket.on('transfer_request', (data) => {
                console.log('æ”¶åˆ°è½¬è´¦è¯·æ±‚:', data);
                showTransferRequest(data);
            });
            
            socket.on('transfer_completed', (data) => {
                console.log('è½¬è´¦å®Œæˆ:', data);
                players = data.players || [];
                renderPlayers();
                showMessage(`${data.fromPlayer} å‘ ${data.toPlayer} è½¬è´¦ ${data.amount} åˆ†`);
                speakText(rhymeVoices.transfer[Math.floor(Math.random() * rhymeVoices.transfer.length)]);
            });
            
            socket.on('game_ended', (data) => {
                console.log('æ¸¸æˆç»“æŸ:', data);
                showVictory(data);
            });
        
        
        // æ›´æ–°è¿æ¥çŠ¶æ€
        function updateConnectionStatus(connected) {
            if (connected) {
                statusIndicator.className = 'status-indicator status-connected';
                statusText.textContent = 'å·²è¿æ¥';
            } else {
                statusIndicator.className = 'status-indicator status-disconnected';
                statusText.textContent = 'å·²æ–­å¼€';
            }
        }
        
        // æ˜¾ç¤ºæ¶ˆæ¯æç¤º
        function showMessage(message, duration = 3000) {
            messageToast.textContent = message;
            messageToast.classList.add('show');
            
            setTimeout(() => {
                messageToast.classList.remove('show');
            }, duration);
        }
        
        // åˆ›å»ºæˆ¿é—´
        function createRoom() {
            const playerName = playerNameInput.value.trim() || `ç©å®¶${Math.floor(Math.random() * 1000)}`;
            
            if (!playerName) {
                showMessage('è¯·è¾“å…¥æ˜µç§°');
                return;
            }
            
            socket.emit('create_room', {
                playerName: playerName
            });
        }
        
        // åŠ å…¥æˆ¿é—´
        function joinRoom() {
            const roomId = roomIdInput.value.trim();
            const playerName = playerNameInput.value.trim() || `ç©å®¶${Math.floor(Math.random() * 1000)}`;
            
            if (!playerName) {
                showMessage('è¯·è¾“å…¥æ˜µç§°');
                return;
            }
            
            if (!roomId) {
                showMessage('è¯·è¾“å…¥æˆ¿é—´å·');
                return;
            }
            
            socket.emit('join_room', {
                roomId: roomId,
                playerName: playerName
            });
        }
        
        // å¤åˆ¶æˆ¿é—´å·
        function copyRoomId() {
            if (!currentRoomId) return;
            
            navigator.clipboard.writeText(currentRoomId)
                .then(() => {
                    showMessage('æˆ¿é—´å·å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                })
                .catch(err => {
                    console.error('å¤åˆ¶å¤±è´¥:', err);
                    showMessage('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
                });
        }
        
        // åˆ†äº«æˆ¿é—´
        function shareRoom() {
            if (!currentRoomId) return;
            
            const shareUrl = `${window.location.origin}?room=${currentRoomId}`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'å®æ—¶ç‰Œå±€è®¡åˆ†å™¨',
                    text: `åŠ å…¥æˆ‘çš„ç‰Œå±€æˆ¿é—´: ${currentRoomId}`,
                    url: shareUrl
                })
                .then(() => console.log('åˆ†äº«æˆåŠŸ'))
                .catch(err => console.log('åˆ†äº«å–æ¶ˆæˆ–å¤±è´¥:', err));
            } else {
                navigator.clipboard.writeText(shareUrl)
                    .then(() => {
                        showMessage('æˆ¿é—´é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                    })
                    .catch(err => {
                        console.error('å¤åˆ¶å¤±è´¥:', err);
                        showMessage('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
                    });
            }
        }
        
        // ç¦»å¼€æˆ¿é—´
        function leaveRoom() {
            if (confirm('ç¡®å®šè¦ç¦»å¼€æˆ¿é—´å—ï¼Ÿ')) {
                socket.emit('leave_room');
                currentRoomId = null;
                currentPlayerId = null;
                players = [];
                onlinePlayers = {};
                
                mainApp.style.display = 'none';
                joinRoomDialog.style.display = 'flex';
                
                showMessage('å·²ç¦»å¼€æˆ¿é—´');
            }
        }
        
        // æ›´æ–°åœ¨çº¿ç©å®¶åˆ—è¡¨
        function updateOnlinePlayers(playersData) {
            onlinePlayers = playersData || {};
            const onlineCount = Object.keys(onlinePlayers).length;
            onlineCountElement.textContent = onlineCount;
            
            // æ›´æ–°åœ¨çº¿ç©å®¶æ˜¾ç¤º
            playersOnlineElement.innerHTML = '';
            
            Object.values(onlinePlayers).forEach(player => {
                const playerStatus = document.createElement('div');
                playerStatus.className = `player-status ${player.connected ? '' : 'offline'}`;
                
                playerStatus.innerHTML = `
                    <div class="player-avatar">${player.avatar || 'ğŸ‘¤'}</div>
                    <div class="player-name">${player.name}</div>
                `;
                
                playersOnlineElement.appendChild(playerStatus);
            });
        }
        
        // æ·»åŠ ç©å®¶
        function addPlayer() {
            if (!currentRoomId) return;
            
            // éšæœºé€‰æ‹©å¤´åƒ
            const randomAvatarIndex = Math.floor(Math.random() * defaultAvatars.length);
            const randomAvatar = defaultAvatars[randomAvatarIndex];
            
            const newPlayer = {
                name: `ç©å®¶${players.length + 1}`,
                score: 100,
                history: [],
                avatar: randomAvatar
            };
            
            socket.emit('add_player', newPlayer);
        }
        
        // ç§»é™¤ç©å®¶
        function removePlayer(playerId) {
            if (!currentRoomId) return;
            
            if (confirm('ç¡®å®šè¦ç§»é™¤è¯¥ç©å®¶å—ï¼Ÿ')) {
                socket.emit('remove_player', { playerId });
            }
        }
        
        // ç©å®¶é—´ç»™åˆ†
        function transferPoints(fromPlayerId, toPlayerId, amount) {
            if (!currentRoomId) return false;
            
            if (!amount || isNaN(amount) || amount <= 0) {
                showMessage('è¯·è¾“å…¥æœ‰æ•ˆçš„æ­£æ•°é‡‘é¢');
                return false;
            }
            
            socket.emit('transfer_points', {
                fromPlayerId,
                toPlayerId,
                amount
            });
            
            return true;
        }
        
        // å‘é€åˆ†æ•°è¯·æ±‚
        function sendRequest(fromPlayerId, toPlayerId, amount) {
            if (!currentRoomId) return false;
            
            if (!amount || isNaN(amount) || amount <= 0) {
                showMessage('è¯·è¾“å…¥æœ‰æ•ˆçš„æ­£æ•°é‡‘é¢');
                return false;
            }
            
            socket.emit('transfer_request', {
                fromPlayerId,
                toPlayerId,
                amount
            });
            
            return true;
        }
        
        // æ˜¾ç¤ºè½¬è´¦è¯·æ±‚å¯¹è¯æ¡†
        function showTransferRequest(data) {
            currentRequest = data;
            
            requestMessage.textContent = `${data.fromPlayer} è¯·æ±‚ä»æ‚¨è¿™é‡Œè·å¾— ${data.amount} åˆ†`;
            requestAmount.textContent = `-${data.amount}`;
            requestDialog.style.display = 'flex';
            
            // æ’­æ”¾è¯·æ±‚è¯­éŸ³
            speakText(rhymeVoices.request[0]);
        }
        
        // æ¥å—åˆ†æ•°è¯·æ±‚
        function acceptRequest() {
            if (!currentRequest || !currentRoomId) return;
            
            socket.emit('accept_request', currentRequest);
            
            // æ’­æ”¾æ¥å—è¯­éŸ³
            speakText(rhymeVoices.accept[0]);
            
            requestDialog.style.display = 'none';
            currentRequest = null;
        }
        
        // æ‹’ç»åˆ†æ•°è¯·æ±‚
        function rejectRequest() {
            if (!currentRequest || !currentRoomId) return;
            
            socket.emit('reject_request', currentRequest);
            
            // æ’­æ”¾æ‹’ç»è¯­éŸ³
            speakText(rhymeVoices.reject[0]);
            
            requestDialog.style.display = 'none';
            currentRequest = null;
        }
        
        // ç›´æ¥è°ƒæ•´åˆ†æ•°
        function adjustScore(playerId, scoreValue) {
            if (!currentRoomId) return;
            
            socket.emit('adjust_score', {
                playerId,
                scoreValue
            });
        }
        
        // æ–°ä¸€å±€
        function newRound() {
            if (!currentRoomId) return;
            
            if (confirm('ç¡®å®šå¼€å§‹æ–°ä¸€å±€å—ï¼Ÿæ‰€æœ‰ç©å®¶çš„å½“å‰åˆ†æ•°å°†å½’é›¶ï¼Œä½†å†å²è®°å½•ä¼šä¿ç•™ã€‚')) {
                socket.emit('new_round');
            }
        }
        
        // å®Œå…¨é‡ç½®
        function resetAll() {
            if (!currentRoomId) return;
            
            if (confirm('ç¡®å®šå®Œå…¨é‡ç½®å—ï¼Ÿæ‰€æœ‰ç©å®¶å’Œæ•°æ®å°†è¢«æ¸…é™¤ï¼Œæ— æ³•æ¢å¤ã€‚')) {
                socket.emit('reset_game');
            }
        }
        
        // æ˜¾ç¤ºç»“ç®—æ’å
        function showSettlement() {
            if (players.length === 0) {
                showMessage('æš‚æ— ç©å®¶ï¼Œè¯·å…ˆæ·»åŠ ç©å®¶ï¼');
                return;
            }
            
            // æŒ‰åˆ†æ•°ä»é«˜åˆ°ä½æ’åº
            const sortedPlayers = [...players].sort((a, b) => b.score - a.score);
            
            // æ¸…ç©ºæ’ååˆ—è¡¨
            rankingsList.innerHTML = '';
            
            // ç”Ÿæˆæ’ååˆ—è¡¨
            sortedPlayers.forEach((player, index) => {
                const rankItem = document.createElement('div');
                rankItem.style.cssText = `
                    display: flex;
                    align-items: center;
                    padding: 12px;
                    margin-bottom: 10px;
                    background: rgba(0, 0, 0, 0.2);
                    border-radius: 8px;
                    border-left: 4px solid ${index === 0 ? '#ffd700' : index === 1 ? '#c0c0c0' : index === 2 ? '#cd7f32' : '#3498db'};
                `;
                
                rankItem.innerHTML = `
                    <div style="font-size: 1.2rem; font-weight: 800; margin-right: 12px; min-width: 30px; color: #ecf0f1;">${index + 1}</div>
                    <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #3498db, #2ecc71); display: flex; align-items: center; justify-content: center; font-size: 20px; color: white; margin-right: 12px;">${player.avatar}</div>
                    <div style="flex: 1;">
                        <div style="font-size: 1rem; font-weight: 700; color: #ecf0f1;">${player.name}</div>
                    </div>
                    <div style="font-size: 1.2rem; font-weight: 800; color: #2ecc71;">${player.score}</div>
                `;
                
                rankingsList.appendChild(rankItem);
            });
            
            // æ˜¾ç¤ºç»“ç®—å¯¹è¯æ¡†
            settlementDialog.style.display = 'flex';
        }
        
        // ç»“æŸæ¸¸æˆ
        function endGame() {
            if (players.length === 0) {
                showMessage('æš‚æ— ç©å®¶ï¼Œè¯·å…ˆæ·»åŠ ç©å®¶ï¼');
                return;
            }
            
            if (!currentRoomId) return;
            
            socket.emit('end_game');
        }
        
        // æ˜¾ç¤ºèƒœåˆ©ç»“ç®—ç”»é¢
        function showVictory(data) {
            const sortedPlayers = data.players || [];
            
            // è·å–èƒœåˆ©è€…ï¼ˆå¯èƒ½æœ‰å¤šäººå¹¶åˆ—ï¼‰
            const topScore = sortedPlayers[0]?.score || 0;
            const winners = sortedPlayers.filter(player => player.score === topScore);
            
            // æ¸…ç©ºèƒœåˆ©ç»“ç®—å†…å®¹
            winnerContainer.innerHTML = '';
            
            // ç”Ÿæˆèƒœåˆ©è€…ä¿¡æ¯
            if (winners.length === 1) {
                // å•ä¸€èƒœåˆ©è€…
                const winner = winners[0];
                winnerContainer.innerHTML = `
                    <div class="crown">ğŸ‘‘</div>
                    <div class="winner-avatar">${winner.avatar}</div>
                    <div class="winner-name">${winner.name}</div>
                    <div class="winner-score">${winner.score} åˆ†</div>
                `;
            } else {
                // å¤šäººå¹¶åˆ—ç¬¬ä¸€
                winnerContainer.innerHTML = `
                    <div class="crown">ğŸ‘‘</div>
                    <div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; margin-bottom: 15px;">
                        ${winners.map(winner => `
                            <div style="text-align: center;">
                                <div class="winner-avatar" style="font-size: 28px; width: 60px; height: 60px;">${winner.avatar}</div>
                                <div style="font-size: 1rem; font-weight: 700; color: #ffd700; margin-top: 8px;">${winner.name}</div>
                            </div>
                        `).join('')}
                    </div>
                    <div class="winner-score">${topScore} åˆ†</div>
                    <div style="margin-top: 8px; color: #bdc3c7; font-size: 1rem;">å¹¶åˆ—ç¬¬ä¸€</div>
                `;
            }
            
            // æ˜¾ç¤ºèƒœåˆ©ç»“ç®—ç”»é¢
            victoryOverlay.style.display = 'flex';
            
            // æ’­æ”¾èƒœåˆ©è¯­éŸ³
            const victoryVoice = rhymeVoices.victory[Math.floor(Math.random() * rhymeVoices.victory.length)];
            speakText(victoryVoice);
        }
        
        // åˆå§‹åŒ–è¯­éŸ³
        function initVoice() {
            if (!window.speechSynthesis) {
                console.warn('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³åˆæˆåŠŸèƒ½');
                voiceToggle.disabled = true;
                voiceStatus.textContent = "ä¸æ”¯æŒ";
                voiceStatus.className = "voice-status voice-off";
                return;
            }
        }
        
        // è¯­éŸ³åˆæˆå‡½æ•°
        function speakText(text, force = false) {
            if ((!voiceEnabled && !force) || !window.speechSynthesis) return;
            
            // åœæ­¢å½“å‰è¯­éŸ³
            window.speechSynthesis.cancel();
            
            // åˆ›å»ºè¯­éŸ³å®ä¾‹
            const utterance = new SpeechSynthesisUtterance(text);
            
            // è®¾ç½®è¯­éŸ³å‚æ•°
            utterance.lang = 'zh-CN';
            utterance.rate = 1.0;
            utterance.pitch = 1.0;
            utterance.volume = 1.0;
            
            // æ’­æ”¾è¯­éŸ³
            window.speechSynthesis.speak(utterance);
        }
        
        // åˆ‡æ¢è¯­éŸ³å¼€å…³
        function toggleVoice() {
            voiceEnabled = voiceToggle.checked;
            updateVoiceStatus();
            
            if (voiceEnabled) {
                speakText("è¯­éŸ³åŠŸèƒ½å·²å¼€å¯", true);
            } else {
                window.speechSynthesis.cancel();
            }
        }
        
        // æ›´æ–°è¯­éŸ³çŠ¶æ€æ˜¾ç¤º
        function updateVoiceStatus() {
            if (voiceEnabled) {
                voiceStatus.textContent = "å¼€å¯";
                voiceStatus.className = "voice-status voice-on";
            } else {
                voiceStatus.textContent = "å…³é—­";
                voiceStatus.className = "voice-status voice-off";
            }
        }
        
        // æ¸²æŸ“æ‰€æœ‰ç©å®¶
        function renderPlayers() {
            // æ¸…ç©ºå®¹å™¨
            playersContainer.innerHTML = '';
            
            // å¦‚æœæ²¡æœ‰ç©å®¶ï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€
            if (players.length === 0) {
                playersContainer.appendChild(emptyState);
                return;
            }
            
            // æ¸²æŸ“æ¯ä¸ªç©å®¶
            players.forEach(player => {
                const playerCard = createPlayerCard(player);
                playersContainer.appendChild(playerCard);
            });
        }
        
        // åˆ›å»ºç©å®¶å¡ç‰‡
        function createPlayerCard(player) {
            const card = document.createElement('div');
            card.className = 'player-card';
            card.dataset.id = player.id;
            
            // ç§»é™¤æŒ‰é’®ï¼ˆåªæœ‰æˆ¿ä¸»å¯ä»¥ç§»é™¤ç©å®¶ï¼‰
            const isOwner = currentPlayerId && onlinePlayers[currentPlayerId]?.isOwner;
            if (isOwner) {
                const removeBtn = document.createElement('button');
                removeBtn.className = 'remove-player';
                removeBtn.innerHTML = 'Ã—';
                removeBtn.addEventListener('click', () => removePlayer(player.id));
                card.appendChild(removeBtn);
            }
            
            // ç©å®¶å¤´éƒ¨
            const playerHeader = document.createElement('div');
            playerHeader.className = 'player-header';
            
            // å¤´åƒ
            const avatar = document.createElement('div');
            avatar.className = 'avatar';
            avatar.innerHTML = player.avatar;
            
            // ç©å®¶åç§°
            const nameInput = document.createElement('div');
            nameInput.className = 'player-name';
            nameInput.textContent = player.name;
            
            playerHeader.appendChild(avatar);
            playerHeader.appendChild(nameInput);
            
            // æ€»åˆ†æ˜¾ç¤º
            const totalScoreContainer = document.createElement('div');
            totalScoreContainer.className = 'total-score-container';
            
            const totalScoreLabel = document.createElement('div');
            totalScoreLabel.className = 'total-score-label';
            totalScoreLabel.textContent = 'å½“å‰æ€»åˆ†';
            
            const totalScore = document.createElement('div');
            totalScore.className = 'total-score';
            totalScore.textContent = player.score;
            
            totalScoreContainer.appendChild(totalScoreLabel);
            totalScoreContainer.appendChild(totalScore);
            
            // ç»™åˆ†æ“ä½œåŒºåŸŸï¼ˆåªæœ‰è‡ªå·±å¯ä»¥ç»™è‡ªå·±æ“ä½œï¼‰
            const transferControls = document.createElement('div');
            transferControls.className = 'transfer-controls';
            
            const transferTitle = document.createElement('div');
            transferTitle.className = 'transfer-title';
            transferTitle.textContent = 'ç©å®¶é—´ç»™åˆ†';
            
            // é€‰æ‹©ç›®æ ‡ç©å®¶
            const targetPlayerRow = document.createElement('div');
            targetPlayerRow.className = 'transfer-row';
            
            const targetPlayerLabel = document.createElement('div');
            targetPlayerLabel.className = 'transfer-label';
            targetPlayerLabel.textContent = 'ç»™åˆ†ç›®æ ‡:';
            
            const targetPlayerSelect = document.createElement('select');
            targetPlayerSelect.className = 'player-select';
            
            // æ·»åŠ é€‰é¡¹
            players.forEach(p => {
                if (p.id !== player.id) {
                    const option = document.createElement('option');
                    option.value = p.id;
                    option.textContent = p.name;
                    targetPlayerSelect.appendChild(option);
                }
            });
            
            targetPlayerRow.appendChild(targetPlayerLabel);
            targetPlayerRow.appendChild(targetPlayerSelect);
            
            // è¾“å…¥é‡‘é¢
            const amountRow = document.createElement('div');
            amountRow.className = 'transfer-row';
            
            const amountLabel = document.createElement('div');
            amountLabel.className = 'transfer-label';
            amountLabel.textContent = 'ç»™åˆ†é‡‘é¢:';
            
            const amountInput = document.createElement('input');
            amountInput.type = 'number';
            amountInput.className = 'transfer-amount';
            amountInput.placeholder = 'è¾“å…¥é‡‘é¢';
            amountInput.min = '1';
            amountInput.value = '10';
            
            amountRow.appendChild(amountLabel);
            amountRow.appendChild(amountInput);
            
            // æŒ‰é’®åŒºåŸŸ
            const buttonRow = document.createElement('div');
            buttonRow.className = 'transfer-buttons';
            
            const sendButton = document.createElement('button');
            sendButton.className = 'transfer-btn transfer-send';
            sendButton.textContent = 'ç›´æ¥ç»™åˆ†';
            sendButton.addEventListener('click', () => {
                const toPlayerId = parseInt(targetPlayerSelect.value);
                const amount = parseInt(amountInput.value);
                
                if (transferPoints(player.id, toPlayerId, amount)) {
                    amountInput.value = '10';
                }
            });
            
            const requestButton = document.createElement('button');
            requestButton.className = 'transfer-btn transfer-request';
            requestButton.textContent = 'è¯·æ±‚ç»™åˆ†';
            requestButton.addEventListener('click', () => {
                const toPlayerId = parseInt(targetPlayerSelect.value);
                const amount = parseInt(amountInput.value);
                
                if (sendRequest(player.id, toPlayerId, amount)) {
                    amountInput.value = '10';
                }
            });
            
            buttonRow.appendChild(sendButton);
            buttonRow.appendChild(requestButton);
            
            transferControls.appendChild(transferTitle);
            transferControls.appendChild(targetPlayerRow);
            transferControls.appendChild(amountRow);
            transferControls.appendChild(buttonRow);
            
            // å¿«æ·æŒ‰é’®åŒº
            const quickButtons = document.createElement('div');
            quickButtons.className = 'quick-score-buttons';
            
            quickScores.forEach(quickScore => {
                const quickBtn = document.createElement('button');
                quickBtn.className = `quick-btn ${quickScore.type}-quick`;
                quickBtn.textContent = quickScore.label;
                quickBtn.addEventListener('click', () => {
                    adjustScore(player.id, quickScore.value);
                });
                quickButtons.appendChild(quickBtn);
            });
            
            transferControls.appendChild(quickButtons);
            
            // å¾—åˆ†å†å²
            const scoreHistory = document.createElement('div');
            scoreHistory.className = 'score-history';
            
            const historyTitle = document.createElement('div');
            historyTitle.className = 'history-title';
            historyTitle.textContent = 'äº¤æ˜“è®°å½•';
            
            const historyList = document.createElement('ul');
            historyList.className = 'history-list';
            
            // æ·»åŠ å†å²è®°å½•
            if (player.history && player.history.length > 0) {
                player.history.forEach(item => {
                    const historyItem = document.createElement('li');
                    
                    // æ ¹æ®è®°å½•ç±»å‹è®¾ç½®æ ·å¼
                    if (item.type === 'transfer_out') {
                        historyItem.className = 'history-item transfer-history';
                        historyItem.textContent = `è½¬ç»™ ${item.target} ${item.amount} åˆ† (æ€»è®¡: ${item.total})`;
                    } else if (item.type === 'transfer_in') {
                        historyItem.className = 'history-item positive-score';
                        historyItem.textContent = `ä» ${item.source} æ”¶åˆ° +${item.amount} åˆ† (æ€»è®¡: ${item.total})`;
                    } else if (item.type === 'adjust') {
                        historyItem.className = `history-item ${item.change >= 0 ? 'positive-score' : 'negative-score'}`;
                        historyItem.textContent = `${item.change >= 0 ? '+' : ''}${item.change} åˆ† (æ€»è®¡: ${item.total})`;
                    }
                    
                    historyList.appendChild(historyItem);
                });
            } else {
                const emptyHistory = document.createElement('li');
                emptyHistory.className = 'history-item';
                emptyHistory.textContent = 'æš‚æ— äº¤æ˜“è®°å½•';
                historyList.appendChild(emptyHistory);
            
            
            scoreHistory.appendChild(historyTitle);
            scoreHistory.appendChild(historyList);
            
            // ç»„è£…å¡ç‰‡
            card.appendChild(playerHeader);
            card.appendChild(totalScoreContainer);
            card.appendChild(transferControls);
            card.appendChild(scoreHistory);
            
            return card;
        }}
        
        // æ£€æŸ¥URLå‚æ•°ï¼Œè‡ªåŠ¨åŠ å…¥æˆ¿é—´
        function checkUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const roomId = urlParams.get('room');
            
            if (roomId) {
                roomIdInput.value = roomId;
                // è‡ªåŠ¨åŠ å…¥æˆ¿é—´
                setTimeout(() => {
                    joinRoomBtn.click();
                }, 500);
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåæ£€æŸ¥URLå‚æ•°
        setTimeout(checkUrlParams, 1000);
    </script>
</body>
</html>
